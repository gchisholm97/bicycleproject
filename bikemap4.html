<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Rental Bicycle Traffic in Chicago</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/6.5.0/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #console {
            position: absolute;
            width: 500px;
            margin: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.8);
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="console" class="collapsed">
        <button id="toggle-console">▼</button>
        <h1>Bicycle Traffic Density in Chicago, IL</h1>
    </div>
    <div id="controls">
        <button id="reset">⏮</button>
        <button id="play">▶</button>
        <button id="pause">⏸</button>
        <input type="range" id="time-slider" min="0" step="1" value="0">
        <span id="time-display">Time: 00:00:00</span>
    </div>
    <script>
        // ... (your map initialization and other setup) ...
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ2NoaXNob2xtOTciLCJhIjoiY200bG8wZGVxMDNmNDJpcTZlZnRiNmhyaCJ9.q3Z-B7c7danrOXXe2lPUfw';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/gchisholm97/cm5wrequm007301qv1dbtck62',
            center: [-87.627454, 41.903424],
            zoom: 15.47,
            pitch: 73.0,
            bearing: -60.92,
        });

        map.on('load', () => {
            // ... (your map source and layer for bike routes) ...
            map.addSource('line-data', {
                type: 'vector',
                url: 'mapbox://gchisholm97.5urz7kmk',
            });

            map.addLayer({
                id: 'bike-routes',
                type: 'line',
                source: 'line-data',
                'source-layer': 'new_lines-886q4q',
                paint: {
                    'line-opacity': 0
                },
            });

            map.addSource('interpolated-points', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }, // Initialize with empty features
            });

            map.addLayer({
                id: 'heatmap-layer',
                type: 'heatmap',
                source: 'interpolated-points',
                paint: {
                    'heatmap-intensity': 1,
                    'heatmap-radius': 4,
                    'heatmap-color': [
                        "interpolate",
                        ["linear"],
                        ["heatmap-density"],
                        0,
                        "rgba(0, 0, 255, 0)",
                        0.1,
                        "royalblue",
                        0.3,
                        "cyan",
                        0.5,
                        "lime",
                        0.7,
                        "yellow",
                        1,
                        "red"
                    ],
                },
            });

            // ... (your time slider, buttons, and variables) ...
            const timeSlider = document.getElementById('time-slider');
            const timeDisplay = document.getElementById('time-display');
            const playButton = document.getElementById('play');
            const pauseButton = document.getElementById('pause');
            const resetButton = document.getElementById('reset');

            const startTime = new Date('2024-07-04T00:00:00Z').getTime();
            const endTime = new Date('2024-07-04T23:59:59Z').getTime();
            const totalSeconds = (endTime - startTime) / 1000;

            timeSlider.max = totalSeconds;
            let frameId = null;
            let isPlaying = false;
            let currentSliderValue = 0;

            let lastUpdate = 0;
            const updateInterval = 100; // Throttle updates to every 100 ms

            function updateInterpolatedPoints(targetTimestamp) {
                const now = Date.now();
                if (now - lastUpdate < updateInterval) return;
                lastUpdate = now;

                const features = map.querySourceFeatures('line-data', { sourceLayer: 'new_lines-886q4q' });
                if (!features) return;

                const interpolatedPoints = []; // Array to hold the calculated points

                for (const feature of features) {
                    const { start_time, end_time } = feature.properties;
                    const start = new Date(start_time).getTime();
                    const end = new Date(end_time).getTime();

                    if (targetTimestamp >= start && targetTimestamp <= end) {
                        const timeRatio = (targetTimestamp - start) / (end - start);
                        const geometry = feature.geometry; // Get the geometry directly

                        //  Simplified for MultiLineStrings ONLY:
                        for (const lineString of geometry.coordinates) {
                            const line = { type: 'Feature', geometry: { type: 'LineString', coordinates: lineString } };
                            const segmentLength = turf.length(line);
                            const alongDistance = timeRatio * turf.length(geometry); // Calculate distance based on total length
                            let cumulativeDistance = 0;

                            for (const ls of geometry.coordinates) {
                                const l = { type: 'Feature', geometry: { type: 'LineString', coordinates: ls } };
                                const lsLength = turf.length(l);
                                if (cumulativeDistance + lsLength >= alongDistance) {
                                    const localRatio = (alongDistance - cumulativeDistance) / lsLength;
                                    const point = turf.along(l, localRatio * lsLength, { units: 'kilometers' });
                                    interpolatedPoints.push(point);
                                    break; // Found the segment
                                }
                                cumulativeDistance += lsLength;
                            }
                        }
                    }
                }


                // *** KEY CHANGE: Update the existing source data ***
                const source = map.getSource('interpolated-points');
                if (source) {
                    source.setData({ type: 'FeatureCollection', features: interpolatedPoints });
                } else {
                    console.error("Source 'interpolated-points' not found!");
                }
            }

            // ... (rest of your event listeners and animation logic) ...
            function animate() {
                currentSliderValue++;
                if (currentSliderValue <= totalSeconds) {
                    timeSlider.value = currentSliderValue;  // Update slider
                    const targetTimestamp = startTime + currentSliderValue * 1000;
                    updateInterpolatedPoints(targetTimestamp);
                    updateTimeDisplay(targetTimestamp); // Update display *here*
                    frameId = requestAnimationFrame(animate);
                } else {
                    stopAnimation();
                }
            }

            function stopAnimation() {
                if (frameId) cancelAnimationFrame(frameId);
                frameId = null;
                isPlaying = false;
                playButton.textContent = '▶';
            }

            function updateTimeDisplay(timestamp) { // Separate function to update the display
                const date = new Date(timestamp);
                const hours = date.getUTCHours().toString().padStart(2, '0');
                const minutes = date.getUTCMinutes().toString().padStart(2, '0');
                const seconds = date.getUTCSeconds().toString().padStart(2, '0');
                timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
            }

            playButton.addEventListener('click', () => {
                if (!isPlaying) {
                    frameId = requestAnimationFrame(animate);
                    playButton.textContent = '⏸';
                    isPlaying = true;
                }
            });

            pauseButton.addEventListener('click', stopAnimation);
            resetButton.addEventListener('click', () => {
                stopAnimation();
                currentSliderValue = 0;
                timeSlider.value = 0;
                const targetTimestamp = startTime; // Reset to start time
                updateInterpolatedPoints(targetTimestamp);
                updateTimeDisplay(targetTimestamp); // Update time display
            });

            timeSlider.addEventListener('input', () => {
                stopAnimation();
                currentSliderValue = parseInt(timeSlider.value, 10);
                const targetTimestamp = startTime + currentSliderValue * 1000; // Calculate timestamp
                updateInterpolatedPoints(targetTimestamp);
                updateTimeDisplay(targetTimestamp); // Update the display *immediately*
            });

            // Initial update of the time display
            updateTimeDisplay(startTime);

        });
    </script>
</body>

</html>